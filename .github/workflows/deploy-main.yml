name: Deploy to AWS Lightsail

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      BASE_URL: https://gspot.ge
      AWS_REGION: eu-central-1
      LIGHTSAIL_SERVICE_NAME: gspot-web
      POSTGRES_SSL: true
      S3_BUCKET: gspot-uploads
      EMAIL_PROVIDER: resend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Docker image
        uses: docker/build-push-action@v4.0.0
        with:
          context: ./src
          push: false
          tags: gspot-web:${{ github.sha }}
          build-args: |
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            NEXTAUTH_URL=${{ env.BASE_URL }}
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Install Lightsail CLI plugin
        run: |
          sudo curl "https://s3.us-west-2.amazonaws.com/lightsailctl/latest/linux-amd64/lightsailctl" -o "/usr/local/bin/lightsailctl"
          sudo chmod +x /usr/local/bin/lightsailctl
      
      - name: Login to AWS Lightsail
        run: |
          aws lightsail get-container-services --service-name ${{ env.LIGHTSAIL_SERVICE_NAME }}
      
      - name: Push image to Lightsail
        run: |
          aws lightsail push-container-image \
            --service-name ${{ env.LIGHTSAIL_SERVICE_NAME }} \
            --label gspot-web \
            --image gspot-web:${{ github.sha }}
      
      - name: Get image reference
        id: image
        run: |
          IMAGE=$(aws lightsail get-container-images --service-name ${{ env.LIGHTSAIL_SERVICE_NAME }} \
            | jq -r '.containerImages[0].image')
          echo "reference=$IMAGE" >> $GITHUB_OUTPUT
      
      - name: Create deployment JSON
        run: |
          cat > deployment.json << EOF
          {
            "containers": {
              "gspot-web": {
                "image": "${{ steps.image.outputs.reference }}",
                "environment": {
                  "NODE_ENV": "production",
                  "POSTGRES_HOST": "${{ secrets.POSTGRES_HOST }}",
                  "POSTGRES_DB": "${{ secrets.POSTGRES_DB }}",
                  "POSTGRES_USER": "${{ secrets.POSTGRES_USER }}",
                  "POSTGRES_PASSWORD": "${{ secrets.POSTGRES_PASSWORD }}",
                  "POSTGRES_SSL": "${{ env.POSTGRES_SSL }}",
                  "REDIS_URL": "${{ secrets.REDIS_URL }}",
                  "NEXTAUTH_SECRET": "${{ secrets.NEXTAUTH_SECRET }}",
                  "NEXTAUTH_URL": "${{ env.BASE_URL }}",
                  "EMAIL_PROVIDER": "${{ env.EMAIL_PROVIDER }}",
                  "EMAIL_PROVIDER_KEY": "${{ secrets.EMAIL_PROVIDER_KEY }}",
                  "AWS_REGION": "${{ env.AWS_REGION }}",
                  "S3_BUCKET": "${{ env.S3_BUCKET }}",
                  "AWSS3_ACCESS_KEY_ID": "${{ secrets.AWSS3_ACCESS_KEY_ID }}",
                  "AWSS3_SECRET_ACCESS_KEY": "${{ secrets.AWSS3_SECRET_ACCESS_KEY }}",
                  "AWSCW_ACCESS_KEY_ID": "${{ secrets.AWSCW_ACCESS_KEY_ID }}",
                  "AWSCW_SECRET_ACCESS_KEY": "${{ secrets.AWSCW_SECRET_ACCESS_KEY }}",
                  "GOOGLE_AUTH_CLIENT_ID": "${{ secrets.GOOGLE_AUTH_CLIENT_ID }}",
                  "GOOGLE_AUTH_CLIENT_SECRET": "${{ secrets.GOOGLE_AUTH_CLIENT_SECRET }}",
                  "GOOGLE_AUTH_REDIRECT_URI": "${{ secrets.GOOGLE_AUTH_REDIRECT_URI }}"
                },
                "ports": {
                  "3000": "HTTP"
                }
              }
            },
            "publicEndpoint": {
              "containerName": "gspot-web",
              "containerPort": 3000,
              "healthCheck": {
                "healthyThreshold": 2,
                "unhealthyThreshold": 2,
                "timeoutSeconds": 5,
                "intervalSeconds": 10,
                "path": "/api/health",
                "successCodes": "200-299"
              }
            }
          }
          EOF
      
      - name: Deploy to Lightsail
        run: |
          aws lightsail create-container-service-deployment \
            --service-name ${{ env.LIGHTSAIL_SERVICE_NAME }} \
            --cli-input-json file://deployment.json
      
      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to complete..."
          for i in {1..30}; do
            STATE=$(aws lightsail get-container-services --service-name ${{ env.LIGHTSAIL_SERVICE_NAME }} \
              | jq -r '.containerServices[0].state')
            if [ "$STATE" == "RUNNING" ]; then
              echo "Deployment successful!"
              exit 0
            fi
            echo "Current state: $STATE. Waiting..."
            sleep 20
          done
          echo "Deployment timeout"
          exit 1
